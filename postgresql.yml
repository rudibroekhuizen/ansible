---
- name: Install PostgreSQL
  hosts: postgresql
  become: true
  gather_facts: true
  roles:
    - postgresql

- name: Postgres | ansible core 
  hosts: postgresql
  become: true
  become_user: postgres
  tasks:
    - name: Create users
      postgresql_user:
        encrypted: true
        name: "{{ item.user }}"
        password: "{{ item.password }}"
        role_attr_flags: "{{ item.roles | default(omit) }}"
        state: present
      with_items:
        - "{{ postgresql_users }}"
      tags: postgresql_users

    - name: Create databases
      become: true
      become_user: postgres
      postgresql_db:
        name: "{{ item.key }}"
        owner: "{{ item.value.owner }}"
        encoding: "{{ item.value.encoding | default('UTF-8') }}"
        template: "{{ item.value.template | default('template0') }}"
      with_dict: "{{ postgresql_databases }}"
      tags: postgresql_databases      

    - name: Set privs
      become: true
      become_user: postgres
      postgresql_privs:
        database: "{{ item.key }}"
        schema: "{{ item.value.schema }}"
        privs: "{{ item.value.privs }}"
        type: "{{ item.value.type | default('table') }}"
        roles: "{{ item.value.roles }}"
      with_dict: "{{ postgresql_privileges }}"
      tags: postgresql_privileges    

- name: Add replication user to postgresql
  hosts: postgresql-master
  become: true
  tasks:
    - name: Install packages needed for managing Postgresql with Ansible
      apt:
        name: python3-psycopg2 #python-psycopg2
        update_cache: yes
        state: present
    - name: Create replication user
      become_user: postgres
      postgresql_user:
        user: replicator
        password: password
        role_attr_flags: REPLICATION
      tags: postgresql_user
...
